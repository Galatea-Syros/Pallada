<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pallada - Consulting Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E53935',
                        secondary: '#F5F5F5',
                        dark: '#424242',
                        light: '#FAFAFA'
                    }
                }
            }
        }
    </script>
    <style>
        .markdown-content h1 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        .markdown-content h2 {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0.75rem 0;
        }
        .markdown-content p {
            margin: 0.5rem 0;
        }
        .markdown-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        .markdown-content ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
        }
        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .markdown-content code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 0.2rem;
            font-family: monospace;
        }
        .chat-container {
            height: calc(100vh - 200px);
        }
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 160px);
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-primary text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                        <span class="text-primary font-bold text-xl">P</span>
                    </div>
                    <h1 class="text-xl font-bold">Pallada</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="new-chat-btn" class="bg-white text-primary px-4 py-2 rounded-md font-medium hover:bg-gray-100 transition">
                        <i class="fas fa-plus mr-2"></i>New Chat
                    </button>
                    <button id="user-menu-btn" class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-primary">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 md:translate-x-0 -translate-x-full absolute md:relative z-10 h-full">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="font-semibold text-dark">Chat History</h2>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto p-2">
                    <!-- Chat history items will be added here -->
                </div>
                <div class="p-4 border-t border-gray-200">
                    <button id="clear-history-btn" class="text-gray-500 hover:text-primary transition">
                        <i class="fas fa-trash-alt mr-2"></i>Clear History
                    </button>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="flex-1 flex flex-col">
                <!-- Chat messages container -->
                <div id="chat-messages" class="chat-container overflow-y-auto p-4 space-y-6">
                    <!-- Welcome message -->
                    <div class="max-w-3xl mx-auto">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex-1">
                                <h3 class="font-semibold text-dark">Pallada</h3>
                                <div class="markdown-content mt-2 text-gray-700">
                                    <p>Hello! I'm Pallada, your consulting intelligence assistant. I can help you analyze documents, answer questions, and provide insights based on your firm's knowledge base.</p>
                                    <p class="mt-2">Try asking me something like:</p>
                                    <ul class="list-disc pl-5 mt-1 space-y-1">
                                        <li>"Summarize the key points from the latest market analysis report"</li>
                                        <li>"What are our recommendations for retail sector clients?"</li>
                                        <li>"Find me case studies about digital transformation in banking"</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input area -->
                <div class="p-4 border-t border-gray-200 bg-white">
                    <div class="max-w-3xl mx-auto">
                        <form id="chat-form" class="relative">
                            <div class="flex items-center">
                                <textarea id="user-input" rows="1" class="flex-1 border border-gray-300 rounded-l-lg p-3 pr-12 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none" placeholder="Ask Pallada anything..."></textarea>
                                <button type="submit" class="bg-primary text-white px-4 py-3 rounded-r-lg hover:bg-red-600 transition">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                                <div>
                                    <button type="button" id="attach-btn" class="hover:text-primary transition">
                                        <i class="fas fa-paperclip mr-1"></i>Attach
                                    </button>
                                </div>
                                <div>
                                    <span id="char-count">0/2000</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="document-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-semibold text-lg">Document Details</h3>
                <button id="close-doc-modal" class="text-gray-500 hover:text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="document-content" class="markdown-content"></div>
                <div id="document-metadata" class="mt-6 border-t border-gray-200 pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">Metadata</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Source</p>
                            <p id="meta-source" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Date</p>
                            <p id="meta-date" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Author</p>
                            <p id="meta-author" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Confidence</p>
                            <p id="meta-confidence" class="font-medium">-</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end">
                <button id="pin-document" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-red-600 transition">
                    <i class="fas fa-thumbtack mr-2"></i>Pin Document
                </button>
            </div>
        </div>
    </div>

    <!-- Pinned Documents Toggle -->
    <button id="toggle-pinned-sidebar" class="fixed right-0 top-20 bg-primary text-white w-8 h-16 rounded-l-lg flex items-center justify-center shadow-lg z-20 hover:bg-red-600 transition" data-collapsed="true">
        <i class="fas fa-chevron-left"></i>
    </button>

    <!-- Pinned Documents Sidebar -->
    <div id="pinned-sidebar" class="fixed right-0 top-20 h-[calc(100vh-5rem)] w-64 bg-white border-l border-gray-200 shadow-lg transform translate-x-full transition-transform duration-300 z-20 flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <div class="flex items-center">
                <button id="toggle-pinned-sidebar" class="mr-2 text-gray-500 hover:text-primary transition-transform duration-200">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <h3 class="font-semibold">Pinned Documents</h3>
            </div>
            <button id="close-pinned-sidebar" class="text-gray-500 hover:text-primary">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="pinned-documents" class="overflow-y-auto flex-1 p-2">
            <!-- Pinned documents will be added here -->
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-thumbtack text-2xl mb-2"></i>
                <p>No pinned documents yet</p>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="md:hidden fixed bottom-4 left-4 bg-primary text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg z-30">
        <i class="fas fa-bars"></i>
    </button>

    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const charCount = document.getElementById('char-count');
        const newChatBtn = document.getElementById('new-chat-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const documentModal = document.getElementById('document-modal');
        const closeDocModal = document.getElementById('close-doc-modal');
        const pinnedSidebar = document.getElementById('pinned-sidebar');
        const closePinnedSidebar = document.getElementById('close-pinned-sidebar');
        const pinDocumentBtn = document.getElementById('pin-document');
        const documentContent = document.getElementById('document-content');

        // State
        let currentChatId = null;
        let activeDocument = null;
        let isPinnedSidebarCollapsed = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadChatHistory();
            updateCharCount();

            // Check for existing chat in localStorage
            const lastChatId = localStorage.getItem('lastChatId');
            if (lastChatId) {
                loadChat(lastChatId);
            }
        });

        // Event Listeners
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        userInput.addEventListener('input', updateCharCount);

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const question = userInput.value.trim();
            if (question) {
                sendQuestion(question);
                userInput.value = '';
                updateCharCount();
            }
        });

        newChatBtn.addEventListener('click', startNewChat);
        clearHistoryBtn.addEventListener('click', clearChatHistory);
        closeDocModal.addEventListener('click', () => documentModal.classList.add('hidden'));
        closePinnedSidebar.addEventListener('click', () => {
            pinnedSidebar.classList.add('translate-x-full');
            const toggleBtn = document.getElementById('toggle-pinned-sidebar');
            toggleBtn.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
            toggleBtn.style.right = '0';
            toggleBtn.dataset.collapsed = 'true';
        });
        pinDocumentBtn.addEventListener('click', pinCurrentDocument);

        // Add toggle pinned sidebar listener
        document.getElementById('toggle-pinned-sidebar').addEventListener('click', (e) => {
            e.stopPropagation();
            const toggleBtn = e.currentTarget;
            const isCollapsed = toggleBtn.dataset.collapsed === 'true';

            if (isCollapsed) {
                pinnedSidebar.classList.remove('translate-x-full');
                toggleBtn.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
                toggleBtn.style.right = '256px'; // 64 * 4 (sidebar width)
                toggleBtn.dataset.collapsed = 'false';
            } else {
                pinnedSidebar.classList.add('translate-x-full');
                toggleBtn.querySelector('i').classList.replace('fa-chevron-right', 'fa-chevron-left');
                toggleBtn.style.right = '0';
                toggleBtn.dataset.collapsed = 'true';
            }
        });

        // Functions
        function updateCharCount() {
            const length = userInput.value.length;
            charCount.textContent = `${length}/2000`;
        }

        function startNewChat() {
            currentChatId = `chat-${Date.now()}`;
            chatMessages.innerHTML = '';
            addWelcomeMessage();
            saveChatToHistory(currentChatId, "New Chat");
            localStorage.setItem('lastChatId', currentChatId);
        }

        function addWelcomeMessage() {
            const welcomeMsg = `
                <div class="max-w-3xl mx-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex-1">
                            <h3 class="font-semibold text-dark">Pallada</h3>
                            <div class="markdown-content mt-2 text-gray-700">
                                <p>Hello! I'm Pallada, your consulting intelligence assistant. How can I help you today?</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', welcomeMsg);
        }

        function sendQuestion(question) {
            if (!currentChatId) {
                currentChatId = `chat-${Date.now()}`;
                saveChatToHistory(currentChatId, question.substring(0, 30) + (question.length > 30 ? "..." : ""));
            }

            // Add user message to chat
            addMessageToChat('user', question);

            // Show loading indicator
            const loadingId = `loading-${Date.now()}`;
            chatMessages.insertAdjacentHTML('beforeend', `
                <div id="${loadingId}" class="max-w-3xl mx-auto">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex-1">
                            <div class="flex space-x-2">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Simulate API call (replace with actual fetch to your Python backend)
            setTimeout(() => {
                simulateApiResponse(question, loadingId);
            }, 1500);
        }

        function simulateApiResponse(question, loadingId) {
            // This is a simulation - replace with actual API call to your Python backend
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) loadingElement.remove();

            // Mock response - in a real implementation, this would come from your API
            const mockResponses = {
                "hello": "Hello! I'm Pallada, your consulting intelligence assistant. How can I help you with your consulting needs today?",
                "what can you do": "I can analyze documents, answer questions based on your firm's knowledge base, provide market insights, and help with research. I can also summarize reports and highlight key findings.",
                "default": `I've analyzed your question about "${question}". Here's what I found:\n\n` +
                    `1. **Key Insight**: Based on our recent market analysis, this topic is gaining importance in the consulting space.\n` +
                    `2. **Recommendation**: Consider focusing on digital transformation aspects for maximum impact.\n\n` +
                    `Would you like me to provide more specific details or references from our knowledge base?`
            };

            const responseText = mockResponses[question.toLowerCase()] || mockResponses['default'];

            // Add mock documents to the response (simulating RAG results)
            const documents = [
                {
                    title: "Market Analysis Q3 2023",
                    content: "This report covers the latest trends in the consulting industry with a focus on digital transformation.",
                    source: "Internal Research",
                    date: "2023-09-15",
                    author: "Analytics Team",
                    confidence: "85%"
                },
                {
                    title: "Client Engagement Framework",
                    content: "Our standardized approach to client engagements that has shown 30% improvement in project outcomes.",
                    source: "Methodology Docs",
                    date: "2023-06-22",
                    author: "Best Practices Team",
                    confidence: "92%"
                }
            ];

            addMessageToChat('assistant', responseText, documents);
        }

        function addMessageToChat(role, content, documents = []) {
            const messageId = `msg-${Date.now()}`;
            const isUser = role === 'user';
            const bgColor = isUser ? 'bg-secondary' : 'bg-white';
            const borderColor = isUser ? 'border-gray-300' : 'border-gray-200';
            const alignment = isUser ? 'ml-auto' : 'mr-auto';

            let messageHTML = `
                <div id="${messageId}" class="max-w-3xl mx-auto ${alignment}">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 ${isUser ? 'bg-gray-600' : 'bg-primary'} rounded-full flex items-center justify-center text-white">
                            ${isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'}
                        </div>
                        <div class="${bgColor} p-4 rounded-lg shadow-sm border ${borderColor} flex-1">
                            <h3 class="font-semibold text-dark">${isUser ? 'You' : 'Pallada'}</h3>
                            <div class="markdown-content mt-2 text-gray-700">
                                ${content}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            chatMessages.insertAdjacentHTML('beforeend', messageHTML);

            // Add documents if present
            if (documents.length > 0) {
                let docsHTML = `
                    <div class="max-w-3xl mx-auto ${isUser ? 'ml-auto' : 'mr-auto'} mt-2">
                        <div class="pl-11">
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">References</h4>
                                <div class="space-y-2">
                `;

                documents.forEach((doc, index) => {
                    docsHTML += `
                        <div class="p-2 bg-white rounded border border-gray-200 hover:border-primary transition cursor-pointer document-item" data-doc='${JSON.stringify(doc)}'>
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-dark">${doc.title}</p>
                                    <p class="text-xs text-gray-500 mt-1">${doc.source} • ${doc.date}</p>
                                </div>
                                <button class="text-gray-400 hover:text-primary document-pin" data-doc='${JSON.stringify(doc)}'>
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                docsHTML += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                chatMessages.insertAdjacentHTML('beforeend', docsHTML);
            }

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Add event listeners to document items
            setTimeout(() => {
                document.querySelectorAll('.document-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('document-pin')) {
                            const doc = JSON.parse(item.getAttribute('data-doc'));
                            showDocumentModal(doc);
                        }
                    });
                });

                document.querySelectorAll('.document-pin').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const doc = JSON.parse(btn.getAttribute('data-doc'));
                        pinDocument(doc);
                    });
                });
            }, 100);
        }

        function showDocumentModal(doc) {
            activeDocument = doc;
            documentContent.innerHTML = `
                <h3 class="font-semibold text-lg mb-4">${doc.title}</h3>
                <div class="prose max-w-none">
                    <p>${doc.content}</p>
                </div>
            `;
            document.getElementById('meta-source').textContent = doc.source;
            document.getElementById('meta-date').textContent = doc.date;
            document.getElementById('meta-author').textContent = doc.author;
            document.getElementById('meta-confidence').textContent = doc.confidence;
            documentModal.classList.remove('hidden');
        }

        function pinCurrentDocument() {
            if (activeDocument) {
                pinDocument(activeDocument);
                documentModal.classList.add('hidden');
            }
        }

        function pinDocument(doc) {
            // Show and expand the pinned sidebar if it's hidden or collapsed
            const toggleBtn = document.getElementById('toggle-pinned-sidebar');
            pinnedSidebar.classList.remove('translate-x-full');
            toggleBtn.querySelector('i').classList.replace('fa-chevron-left', 'fa-chevron-right');
            toggleBtn.style.right = '256px';
            toggleBtn.dataset.collapsed = 'false';

            // Check if the "no documents" message is showing and remove it
            const noDocsMsg = pinnedSidebar.querySelector('.text-center');
            if (noDocsMsg) noDocsMsg.remove();

            // Add the document to the pinned sidebar
            const pinnedDocHTML = `
                <div class="p-3 bg-white rounded-lg border border-gray-200 mb-2 hover:shadow-md transition cursor-pointer pinned-doc" data-doc='${JSON.stringify(doc)}'>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium text-dark">${doc.title}</p>
                            <p class="text-xs text-gray-500 mt-1">${doc.source} • ${doc.date}</p>
                        </div>
                        <button class="text-primary hover:text-red-600 unpin-doc">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('pinned-documents').insertAdjacentHTML('afterbegin', pinnedDocHTML);

            // Add event listeners
            const pinnedDoc = document.querySelector('.pinned-doc');
            pinnedDoc.addEventListener('click', (e) => {
                if (!e.target.classList.contains('unpin-doc')) {
                    showDocumentModal(doc);
                }
            });

            pinnedDoc.querySelector('.unpin-doc').addEventListener('click', (e) => {
                e.stopPropagation();
                pinnedDoc.remove();

                // If no pinned docs left, show the empty message
                if (document.querySelectorAll('.pinned-doc').length === 0) {
                    document.getElementById('pinned-documents').innerHTML = `
                        <div class="text-center py-10 text-gray-400">
                            <i class="fas fa-thumbtack text-2xl mb-2"></i>
                            <p>No pinned documents yet</p>
                        </div>
                    `;
                }
            });

            // Show a confirmation toast
            showToast(`"${doc.title}" pinned successfully`);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-dark text-white px-4 py-2 rounded-md shadow-lg flex items-center';
            toast.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function loadChatHistory() {
            // In a real implementation, this would load from localStorage or your backend
            const chatHistory = document.getElementById('chat-history');

            // Mock data
            const mockChats = [
                { id: 'chat-1', title: 'Market trends analysis' },
                { id: 'chat-2', title: 'Client engagement strategy' },
                { id: 'chat-3', title: 'Digital transformation' }
            ];

            mockChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'p-3 rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                chatItem.innerHTML = `
                    <span>${chat.title}</span>
                    <button class="text-gray-400 hover:text-primary delete-chat" data-chatid="${chat.id}">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                `;
                chatItem.addEventListener('click', () => loadChat(chat.id));

                const deleteBtn = chatItem.querySelector('.delete-chat');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                });

                chatHistory.appendChild(chatItem);
            });
        }

        function loadChat(chatId) {
            // In a real implementation, this would load the chat from your backend
            currentChatId = chatId;
            chatMessages.innerHTML = '';
            addWelcomeMessage();

            // Simulate loading a previous chat
            setTimeout(() => {
                addMessageToChat('user', 'What are the latest market trends?');
                setTimeout(() => {
                    simulateApiResponse('What are the latest market trends?', null);
                }, 500);
            }, 300);

            localStorage.setItem('lastChatId', chatId);
        }

        function saveChatToHistory(chatId, title) {
            // In a real implementation, this would save to localStorage or your backend
            const chatHistory = document.getElementById('chat-history');

            // Check if this chat already exists in history
            const existingChat = document.querySelector(`[data-chatid="${chatId}"]`);
            if (existingChat) {
                existingChat.querySelector('span').textContent = title;
                return;
            }

            const chatItem = document.createElement('div');
            chatItem.className = 'p-3 rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center';
            chatItem.innerHTML = `
                <span>${title}</span>
                <button class="text-gray-400 hover:text-primary delete-chat" data-chatid="${chatId}">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>
            `;
            chatItem.addEventListener('click', () => loadChat(chatId));

            const deleteBtn = chatItem.querySelector('.delete-chat');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chatId);
            });

            chatHistory.insertBefore(chatItem, chatHistory.firstChild);
        }

        function deleteChat(chatId) {
            // In a real implementation, this would delete from localStorage or your backend
            const chatItem = document.querySelector(`[data-chatid="${chatId}"]`).parentNode;
            chatItem.remove();

            if (currentChatId === chatId) {
                startNewChat();
            }
        }

        function clearChatHistory() {
            // In a real implementation, this would clear localStorage or your backend
            if (confirm('Are you sure you want to clear all chat history?')) {
                document.getElementById('chat-history').innerHTML = '';
                startNewChat();
            }
        }
    </script>
</body>
</html>